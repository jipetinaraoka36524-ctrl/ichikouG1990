<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ã„å‡ºã®ã‚¯ã‚¤ã‚º - å®Œå…¨çµ±åˆç‰ˆ</title>
    <style>
        :root {
            --sepia-dark: #120a06;
            --sepia-light: #f1e3c7;
            --accent: #ffe7a6;
            --gold: #bfa57d;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--sepia-dark);
            color: var(--sepia-light);
            font-family: 'Hiragino Mincho ProN', 'serif';
            display: flex; justify-content: center; align-items: center;
            overflow-x: hidden;
        }

        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--sepia-dark); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }

        .section {
            display: none; text-align: center; width: 100%; height: 100%;
            max-width: 1200px; padding: 2vh 2vw; box-sizing: border-box;
        }
        .active { display: flex; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn .6s forwards; }

        h1 { font-size: 7.5vw; margin: 0 0 2vh; }
        h2 { font-size: 6.5vw; }
        p, textarea { font-size: 4.8vw; }
        .question-text { font-size: 5.2vw; line-height: 1.6; margin-bottom: 4vh; }
        .question-num { font-size: 5.2vw; color: var(--accent); margin-bottom: 2vh; }

        .submit-btn, .option-btn {
            font-size: 5.0vw; padding: 2vh 3vw; border-radius: 18px;
            border: 3px solid var(--sepia-light); background: rgba(0,0,0,.2);
            color: var(--sepia-light); cursor: pointer; margin: 1vh 0.5vw;
            width: 90%; max-width: 900px; font-family: inherit; transition: 0.3s;
        }
        .option-btn:hover, .submit-btn:hover { background: var(--sepia-light); color: var(--sepia-dark); }

        /* ä¿®æ­£ï¼šãƒœã‚¿ãƒ³ãŒä¸­å¤®ã«ä¸¦ã¶ã‚ˆã†ã«èª¿æ•´ */
        #options-area { 
            display: flex; flex-direction: column; align-items: center; 
            gap: 1.5vh; width: 100%; 
        }

        #answer-input, #author-input {
            width: 95%; font-size: 5.2vw; padding: 1.5vh 1vw; text-align: center;
            border: none; border-bottom: 4px solid var(--sepia-light);
            background: transparent; color: var(--sepia-light); outline: none; font-family: inherit;
        }

        .comment-box {
            background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px;
            text-align: left; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);
            font-size: 5.2vw; line-height: 1.4;
        }
        .edit-btn {
            background: none; border: 1px solid var(--accent); color: var(--accent);
            padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 0.8em; margin-top: 10px;
        }

        .ending-scroll { height: 400px; overflow: hidden; position: relative; width: 100%; }
        .scroll-content { 
            position: absolute; width: 100%; 
            animation: scrollUp 20s linear forwards; 
            font-size: 5vw; line-height: 3.0; 
        }
        .fin-text { 
            font-size: 15vw; letter-spacing: 2.5rem; opacity: 0; 
            animation: fadeIn 6s forwards 18s, fadeOut 4s forwards 28s; 
        }

        .opening-title {
            font-size: 12vw; letter-spacing: 1.0rem; color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 20px rgba(255, 231, 166, 0.5);
            filter: blur(5px); animation: blurIn 3s forwards; font-weight: bold;
        }

        @keyframes blurIn { 0% { filter: blur(20px); opacity: 0; } 100% { filter: blur(0px); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes scrollUp { 
            0% { transform: translateY(10%); opacity: 1; } 
            90% { opacity: 1; } 
            100% { transform: translateY(-110%); opacity: 0; } 
        }

        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 100; pointer-events: none; }
        .flash-hit { animation: flashAnim 0.6s ease-out; }
        @keyframes flashAnim { 0% { opacity: 0; } 50% { opacity: 0.4; } 100% { opacity: 0; } }

        #scene-editor { justify-content: flex-start; overflow-y: auto; }
        .editor-header-fixed {
            position: sticky; top: 0; left: 0; width: 100%; background: var(--sepia-dark); z-index: 1000; padding-bottom: 15px; border-bottom: 2px solid var(--gold);
        }
        .editor-card { 
            background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; border: 1px solid var(--gold); width: 95%; max-width: 600px; margin: 10px auto;
        }
        .editor-label { color: var(--accent); font-size: 5.5vw; font-weight: bold; display: block; margin-bottom: 10px; text-align: left; }
        .quiz-item-card { 
            background: rgba(255,255,255,0.1); padding: 15px; margin: 10px auto; border-radius: 8px; font-size: 4vw; display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 600px;
        }
        #q-type, #q-options, #q-correct, #q-answer-text, #scene-editor textarea {
            width: 100%; font-size: 4.5vw; padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--gold); border-radius: 8px; box-sizing: border-box; font-family: inherit; display: block; margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="start-overlay" onclick="initApp()">
        <div style="font-size: 6vw; color: var(--gold); border: 2px solid var(--gold); padding: 20px; border-radius: 50px;">
            Tap to Start
        </div>
    </div>

    <audio id="bgm" src="melody.mp3" loop></audio>

    <div class="flash" id="flash"></div>

    <div id="scene-opening" class="section">
        <div style="font-size: 10vw; color: var(--gold); margin-bottom: 15px;">Memory Quiz</div>
        <div class="opening-title">æ€ã„å‡ºã®ã‚¯ã‚¤ã‚º</div>
    </div>

    <div id="scene-select" class="section">
        <h1 id="select-title">æ€ã„å‡ºã‚¯ã‚¤ã‚º</h1>
        <p id="select-guide">å•é¡Œã‚’é¸ã‚“ã§ãã ã•ã„</p>
        <div id="question-list" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        <div id="ending-trigger" style="display:none; margin-top: 4vh; width: 100%; text-align: center;">
            <button class="submit-btn" style="border-color: var(--gold); color: var(--gold); background: rgba(191,165,125,0.1); width: 90%;" onclick="startEnding()">
                âœ¨ æ€ã„å‡ºã‚’å®Œçµã•ã›ã‚‹
            </button>
        </div>
        <button class="submit-btn" style="margin-top: 5vh; font-size: 5vw; opacity: 0.8; border-color: var(--gold);" onclick="show('scene-editor');">
            âš™ å•é¡Œã‚’ç·¨é›†ã™ã‚‹
        </button>
    </div>

    <div id="scene-editor" class="section">
        <div class="editor-header-fixed">
            <h2 style="color: var(--gold); margin: 20px 0 10px 0;">å•é¡Œã‚’ç·¨é›†</h2>
            <div class="editor-card">
                <div style="margin-bottom: 15px;">
                    <label class="editor-label">ã€å‡ºé¡Œå½¢å¼ã€‘</label>
                    <select id="q-type" onchange="toggleType()">
                        <option value="choice">é¸æŠè‚¢å•é¡Œ</option>
                        <option value="input">è¨˜è¿°å•é¡Œ</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="editor-label">ã€å•é¡Œæ–‡ã€‘</label>
                    <textarea id="q-text" rows="2" placeholder="ä¾‹ï¼šåˆã‚ã¦æ—…è¡Œã«è¡Œã£ãŸå ´æ‰€ã¯ï¼Ÿ"></textarea>
                </div>
                <div id="choice-inputs">
                    <label class="editor-label">ã€é¸æŠè‚¢ã¨æ­£è§£ã€‘</label>
                    <input type="text" id="q-options" placeholder="é¸æŠè‚¢ã‚’ã‚«ãƒ³ãƒ(,)åŒºåˆ‡ã‚Šã§å…¥åŠ›">
                    <div style="margin-top:10px; text-align: left; font-size: 4.5vw; color: var(--accent);">
                        æ­£è§£ç•ªå· (å·¦ã‹ã‚‰æ•°ãˆã¦): <input type="number" id="q-correct" min="1" value="1" style="width: 80px; text-align: center; display: inline-block; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--gold); border-radius: 8px;">
                    </div>
                </div>
                <div id="text-inputs" style="display:none">
                    <label class="editor-label">ã€æ­£è§£ã®è¨€è‘‰ã€‘</label>
                    <input type="text" id="q-answer-text" placeholder="æ­£è§£ã‚’å…¥åŠ›">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="submit-btn" style="flex: 2; margin: 0; font-size: 4.5vw;" onclick="addQuestion()">ï¼‹ è¿½åŠ </button>
                    <button class="submit-btn" style="flex: 1; margin: 0; font-size: 4.5vw; border-color: var(--gold);" onclick="show('scene-select')">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>
        <div id="question-list-admin" style="width: 100%; padding-top: 10px; padding-bottom: 50px;"></div>
    </div>

    <div id="scene-quiz" class="section">
        <div id="question-num" class="question-num"></div>
        <div id="question-text" class="question-text"></div>
        <div id="options-area"></div>
        <div id="input-area" style="display:none; width: 100%;">
            <input id="answer-input" placeholder="ç­”ãˆã‚’å…¥åŠ›â€¦">
            <button class="submit-btn" style="margin-top: 20px;" onclick="checkTextAnswer()">å›ç­”ã™ã‚‹</button>
        </div>
        <button class="submit-btn" style="font-size: 4vw; margin-top: 3vh; opacity: 0.7;" onclick="openCommentsOnly(currentQuestion)">æŠ•ç¨¿ã ã‘è¦‹ã‚‹</button>
    </div>

    <div id="scene-comment" class="section" style="justify-content: flex-start; overflow-y: auto;">
        <h2 id="judge-text">çµæœ</h2>
        <div id="comment-list" style="width: 90%;"></div>
        <div class="comment-box" style="width: 90%; border: 2px solid var(--accent); box-sizing: border-box;">
            <p>æŠ•ç¨¿è€…å</p>
            <input id="author-input" placeholder="ãŠåå‰">
            <p style="margin-top:2vh;">ã‚³ãƒ¡ãƒ³ãƒˆ</p>
            <textarea id="comment-input" style="width:100%; height:15vh; background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--gold); border-radius: 8px;"></textarea>
            <button class="submit-btn" onclick="postComment()">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
        <button class="submit-btn" onclick="show('scene-select')">æˆ»ã‚‹</button>
    </div>

    <div id="scene-ending" class="section">
        <div class="ending-scroll">
            <div class="scroll-content">
                <p>ã‚ã®æ—¥ã€ã‚ã®æ™‚ã€ã‚ã®å ´æ‰€ã§ã€‚</p><br>
                <p>ç©ã¿é‡ã­ã¦ããŸå¤§åˆ‡ãªæ™‚é–“ã€‚</p><br>
                <p>ä¸€ã¤ä¸€ã¤ã®è¨˜æ†¶ãŒã€</p><br>
                <p>ä»Šã®ç§ãŸã¡ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚</p><br>
                <p>å¿˜ã‚Œã¦ã„ãŸã“ã¨ã‚‚ã€</p><br>
                <p>è¦šãˆã¦ã„ã‚‹ã“ã¨ã‚‚ã€</p><br>
                <p>ã™ã¹ã¦ãŒã‹ã‘ãŒãˆã®ãªã„å®ç‰©ã€‚</p><br>
                <p>å…±ã«æ­©ã‚“ã§ãã‚Œã¦ã€ã‚ã‚ŠãŒã¨ã†ã€‚</p>
            </div>
        </div>
        <div class="fin-text">ä¸€é–¢ä¸€é«˜ã€€Gçµ„ã€€1990å¹´ã€€å’æ¥­ç”Ÿ</div>
    </div>

    <script>
        // å›ºå®šã®å•é¡Œ1
        const FIXED_Q1 = {type:"choice", question:"è‡ªç”±ã«æŠ•ç¨¿ã—ã¦ã­âœ¨ï¸", options:["æŠ•ç¨¿ã™ã‚‹"], answer:-1};

        let rawData = JSON.parse(localStorage.getItem("memory_quiz_v2")) || [];
        if (rawData.length === 0) {
            rawData = [FIXED_Q1];
        } else {
            rawData[0] = FIXED_Q1;
        }
        let quizData = rawData;

        let currentQuestion = 0;

        function initApp() {
            const bgm = document.getElementById('bgm');
            bgm.play().catch(e => console.log("Audio play blocked"));
            document.getElementById('start-overlay').style.display = 'none';
            show('scene-opening');
            setTimeout(() => show('scene-select'), 5000);
        }

        function show(id) {
            document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
            const target = document.getElementById(id);
            if(target) {
                target.classList.add("active");
                if(id === 'scene-select') buildQuestionList();
                if(id === 'scene-editor') renderAdminList();
            }
        }

        function buildQuestionList() {
            const list = document.getElementById("question-list");
            list.innerHTML = "";
            let correctCount = 0;
            quizData.forEach((q, i) => {
                const isCleared = localStorage.getItem("q_cleared_" + i) === "true";
                if(isCleared) correctCount++;
                const btn = document.createElement("button");
                btn.className = "submit-btn";
                const count = localStorage.getItem("new_count_" + i) || 0;
                btn.innerText = `ç¬¬${i+1}å•: ${q.question}${isCleared ? " âœ…" : ""}${count > 0 ? " ğŸ””"+count : ""}`;
                btn.onclick = () => {
                    currentQuestion = i;
                    localStorage.removeItem("new_count_" + i);
                    loadQuestion();
                    show('scene-quiz');
                };
                list.appendChild(btn);
            });
            document.getElementById("ending-trigger").style.display = (correctCount === quizData.length && quizData.length > 0) ? "block" : "none";
        }

        // ä¿®æ­£ï¼šé¸æŠè‚¢ã®æ•°ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹é–¢æ•°
        function loadQuestion() {
            const d = quizData[currentQuestion];
            document.getElementById("question-num").innerText = `ç¬¬${currentQuestion+1}å•`;
            document.getElementById("question-text").innerText = d.question;
            
            const optionsArea = document.getElementById("options-area");
            const inputArea = document.getElementById("input-area");
            optionsArea.innerHTML = ""; // ä»¥å‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

            if(d.type === "choice") {
                optionsArea.style.display = "flex";
                inputArea.style.display = "none";
                
                // é¸æŠè‚¢é…åˆ—ã®æ•°ã ã‘ãƒœã‚¿ãƒ³ã‚’ãƒ«ãƒ¼ãƒ—ç”Ÿæˆ
                d.options.forEach((optText, index) => {
                    const btn = document.createElement("button");
                    btn.className = "option-btn";
                    btn.innerText = optText;
                    btn.onclick = () => checkAnswer(index);
                    optionsArea.appendChild(btn);
                });
            } else {
                optionsArea.style.display = "none";
                inputArea.style.display = "block";
                document.getElementById("answer-input").value = "";
            }
        }

        function checkAnswer(i) {
            let ok = (currentQuestion === 0) ? true : (i === quizData[currentQuestion].answer);
            if(ok) { localStorage.setItem("q_cleared_" + currentQuestion, "true"); triggerFlash(); }
            showResult(ok);
        }

        function checkTextAnswer() {
            let ok = (currentQuestion === 0) ? true : (document.getElementById("answer-input").value.trim() === quizData[currentQuestion].answer);
            if(ok) { localStorage.setItem("q_cleared_" + currentQuestion, "true"); triggerFlash(); }
            showResult(ok);
        }

        function showResult(ok) {
            document.getElementById("judge-text").innerText = ok ? "æ­£è§£ï¼" : "æ®‹å¿µâ€¦";
            loadComments();
            show('scene-comment');
        }

        function openCommentsOnly(i) {
            currentQuestion = i;
            document.getElementById("judge-text").innerText = "æŠ•ç¨¿ä¸€è¦§";
            loadComments();
            show('scene-comment');
        }

        function loadComments() {
            const list = document.getElementById("comment-list");
            list.innerHTML = "";
            const comments = JSON.parse(localStorage.getItem("comments_" + currentQuestion) || "[]");
            comments.forEach((c, idx) => {
                const box = document.createElement("div");
                box.className = "comment-box";
                if(c.isMy) box.style.background = "rgba(255,231,166,0.1)";
                box.innerHTML = `<strong>ğŸ‘¤ ${c.name}</strong><br><p>${c.text}</p>`;
                if(c.isMy) {
                    const eb = document.createElement("button");
                    eb.innerText = "âœ ç·¨é›†"; eb.className = "edit-btn";
                    eb.onclick = () => {
                        const nt = prompt("ç·¨é›†:", c.text);
                        if(nt) { comments[idx].text = nt; localStorage.setItem("comments_"+currentQuestion, JSON.stringify(comments)); loadComments(); }
                    };
                    box.appendChild(eb);
                }
                list.appendChild(box);
            });
        }

        function postComment() {
            const name = document.getElementById("author-input").value.trim();
            const text = document.getElementById("comment-input").value.trim();
            if(!name || !text) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
            const comments = JSON.parse(localStorage.getItem("comments_" + currentQuestion) || "[]");
            comments.push({ name, text, isMy: true });
            localStorage.setItem("comments_" + currentQuestion, JSON.stringify(comments));
            localStorage.setItem("new_count_" + currentQuestion, parseInt(localStorage.getItem("new_count_"+currentQuestion)||0)+1);
            document.getElementById("comment-input").value = "";
            loadComments();
        }

        function toggleType() {
            const t = document.getElementById('q-type').value;
            document.getElementById('choice-inputs').style.display = t === 'choice' ? 'block' : 'none';
            document.getElementById('text-inputs').style.display = t === 'input' ? 'block' : 'none';
        }

        function addQuestion() {
            const type = document.getElementById('q-type').value;
            const text = document.getElementById('q-text').value.trim();
            if(!text) return alert("å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            let nq = { type, question: text };
            if(type === 'choice') {
                nq.options = document.getElementById('q-options').value.split(',').map(s => s.trim()).filter(s => s !== "");
                nq.answer = parseInt(document.getElementById('q-correct').value) - 1;
            } else {
                nq.answer = document.getElementById('q-answer-text').value.trim();
            }
            quizData.push(nq);
            saveData();
            renderAdminList();
            document.getElementById('q-text').value = "";
            document.getElementById('q-options').value = "";
        }

        function renderAdminList() {
            const list = document.getElementById('question-list-admin');
            list.innerHTML = quizData.map((q, i) => `
                <div class="quiz-item-card">
                    <span style="text-align:left; flex:1;">${i+1}. ${q.question}</span>
                    ${i === 0 ? '<span style="color:var(--accent); font-size: 3.5vw;">[ã‚·ã‚¹ãƒ†ãƒ å›ºå®š]</span>' : `<span style="color:#ff6b6b; cursor:pointer; font-weight:bold; padding: 10px;" onclick="deleteQ(${i})">å‰Šé™¤</span>`}
                </div>
            `).join('') + `<div style="height:50px;"></div>`;
        }

        function deleteQ(i) {
            if(i === 0) return alert("å•é¡Œ1ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
            if(confirm("ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { quizData.splice(i, 1); saveData(); renderAdminList(); }
        }

        function saveData() { localStorage.setItem("memory_quiz_v2", JSON.stringify(quizData)); }

        function triggerFlash() {
            const f = document.getElementById('flash');
            f.classList.remove('flash-hit'); void f.offsetWidth; f.classList.add('flash-hit');
        }

        function startEnding() {
            show('scene-ending');
            setTimeout(() => { location.reload(); }, 35000);
        }
    </script>
</body>
</html>